{
	"mode": "Indexed",
	"policyRule": {
		"if": {
			"field": "type",
			"equals": "Microsoft.ContainerService/managedClusters"
		},
		"then": {
			"effect": "deployIfNotExists",
			"details": {
				"type": "Microsoft.ContainerService/managedClusters",
				"name": "[field('name')]",
				"roleDefinitionIds": [
					"/providers/Microsoft.Authorization/roleDefinitions/ed7f3fbd-7b88-4dd4-9017-9adb7ce333f8",
					"/providers/Microsoft.Authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
				],
				"existenceCondition": {
					"field": "Microsoft.ContainerService/managedClusters/addonProfiles.omsagent.enabled",
					"equals": "true"
				},
				"deployment": {
					"properties": {
						"mode": "incremental",
						"template": {
							"$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
							"contentVersion": "1.0.0.0",
							"parameters": {
								"clusterName": {
									"type": "string"
								},
								"clusterResourceGroupName": {
									"type": "string"
								},
								"clusterLocation": {
									"type": "string"
								}
							},
							"variables": {
								"region": {
									"US": [
										"eastus2",
										"centralus"
									],
									"APAC": [
										"southeastasia"
									],
									"EU": [
										"westeurope",
										"northeurope"
									]
								},
								"laWorkspaceId": {
									"US": "/subscriptions/5c8f3e12-757e-4183-a8d0-80effb7bf97f/resourcegroups/saty-public-rg/providers/microsoft.operationalinsights/workspaces/saty-public-la",
									"APAC": "/subscriptions/5c8f3e12-757e-4183-a8d0-80effb7bf97f/resourcegroups/saty-public-rg/providers/microsoft.operationalinsights/workspaces/saty-apac-la",
									"EU": "/subscriptions/5c8f3e12-757e-4183-a8d0-80effb7bf97f/resourcegroups/saty-public-rg/providers/microsoft.operationalinsights/workspaces/saty-eu-la",
									"CH": "/subscriptions/5c8f3e12-757e-4183-a8d0-80effb7bf97f/resourcegroups/saty-public-rg/providers/microsoft.operationalinsights/workspaces/saty-public-la"
								}
							},
							"resources": [
								{
									"type": "Microsoft.Resources/deployments",
									"name": "[Concat('aks-monitoring-policy', '-',  uniqueString(parameters('clusterName')))]",
									"apiVersion": "2019-05-01",
									"properties": {
										"mode": "Incremental",
										"template": {
											"$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
											"contentVersion": "1.0.0.0",
											"parameters": {},
											"variables": {},
											"resources": [
												{
													"name": "[parameters('clusterName')]",
													"type": "Microsoft.ContainerService/managedClusters",
													"location": "[parameters('clusterLocation')]",
													"apiVersion": "2018-03-31",
													"properties": {
														"mode": "Incremental",
														"id": "[resourceId(parameters('clusterResourceGroupName'), 'Microsoft.ContainerService/managedClusters', parameters('clusterName'))]",
														"addonProfiles": {
															"omsagent": {
																"enabled": true,
																"config": {
																	"logAnalyticsWorkspaceResourceID": "[if(contains(variables('region').US, toLower(parameters('clusterLocation'))), variables('laWorkspaceId').US, if(contains(variables('region').APAC, toLower(parameters('clusterLocation'))), variables('laWorkspaceId').APAC, if(contains(variables('region').EU, toLower(parameters('clusterLocation'))), variables('laWorkspaceId').EU, variables('laWorkspaceId').CH)))]"
																}
															}
														}
													}
												}
											]
										}
									}
								}
							]
						},
						"parameters": {
							"clusterName": {
								"value": "[field('name')]"
							},
							"clusterResourceGroupName": {
								"value": "[resourceGroup().name]"
							},
							"clusterLocation": {
								"value": "[field('location')]"
							}
						}
					}
				}
			}
		}
	}
}